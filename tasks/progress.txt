# Ralph Progress Log
# Project: 相关笔记无限滚动列表
# Branch: ralph/feature-20260219

## Codebase Patterns
- API functions use apiGet/apiPost/etc. from api/common.ts
- API errors are thrown for callers to handle (try/catch in services)
- RelatedMemoItem needs both `id` (for PRD) and `memoId` (for existing UI)
- RelatedMemoItem uses `relevanceScore` (0-1) for new API, `similarity` for backward compatibility
- Infinite scroll: Use ScrollView onScroll event with scrollEventThrottle, check scroll position against content size
- Components using services must be wrapped with `view()` and exported with `bindServices()`
- Always export new components from components/memos/index.ts for clean imports
- When using RelatedMemoList inside ScrollView, give it a fixed height (e.g., 300px) instead of flex:1

## Stories
- [x] US-001: 创建相关笔记服务接口
- [x] US-002: 创建相关笔记 Service 层
- [x] US-003: 创建相关笔记列表组件
- [x] US-004: 创建相关性分数组件
- [x] US-005: 集成相关笔记到详情页

## Completed

## Notes

---

## 2025-02-19 22:46 - US-001
- What was implemented:
  - Added `RelatedMemoItem` interface in `types/memo.ts` with fields: id, memoId, content, createTime, relevanceScore, similarity
  - Updated `RelatedMemosResponse` to include pagination metadata (total, page, limit, totalPages)
  - Updated `getRelatedMemos()` API function to accept page and pageSize parameters
  - Updated `memo-service.ts` to use the new `RelatedMemoItem` type
- Files changed:
  - `types/memo.ts`: Added RelatedMemoItem interface, updated RelatedMemosResponse
  - `api/memo.ts`: Updated getRelatedMemos function signature with page/pageSize
  - `services/memo-service.ts`: Updated relatedMemos type and API call
- **Learnings for future iterations:**
  - The existing UI in `app/(memos)/[id].tsx` uses `memoId` and `similarity` properties
  - New PRD requires `id` and `relevanceScore` properties
  - To maintain backward compatibility during transition, include both sets of properties
  - Use lowercase commit messages (commitlint enforces this)
  - Run `npx tsc --noEmit` to check types before committing
---

## 2025-02-19 23:05 - US-002
- What was implemented:
  - Created `services/related-memo-service.ts` extending @rabjs/react Service class
  - Added observable state properties: relatedMemos, loading, hasMore, currentPage, error
  - Implemented `loadRelatedMemos(memoId)` method with automatic pagination handling
  - Implemented `refreshRelatedMemos(memoId)` for manual refresh
  - Implemented `reset()` method to clear state when switching memos
  - Added currentMemoId tracking to detect memo switches and auto-reset
- Files changed:
  - `services/related-memo-service.ts`: New service for related memos state management
- **Learnings for future iterations:**
  - @rabjs/react Service class provides automatic reactivity - no decorators needed for observable properties
  - Service methods should handle state reset when memoId changes (for infinite scroll scenarios)
  - The pattern for infinite scroll: check hasMore/loading before fetch, update hasMore based on pagination data
  - Commit messages must be lowercase (commitlint enforces subject-case: never [sentence-case, start-case, pascal-case, upper-case])
  - Use kebab-case for service files (e.g., `related-memo-service.ts`)
---

## 2025-02-19 23:30 - US-003
- What was implemented:
  - Created `components/memos/related-memo-list.tsx` component
  - Used `bindServices` pattern to bind RelatedMemoService
  - Implemented infinite scroll using ScrollView onScroll event with scrollEventThrottle=400
  - Added loading indicator at bottom when fetching more data
  - Added "已加载全部相关笔记" footer when hasMore is false
  - Added empty state with icon when no related memos found
  - Added error state display
  - Styled cards to match existing memo-item patterns
  - Exported component from `components/memos/index.ts`
- Files changed:
  - `components/memos/related-memo-list.tsx`: New component with infinite scroll list
  - `components/memos/index.ts`: Added export for RelatedMemoList
- **Learnings for future iterations:**
  - Infinite scroll implementation: Check `layoutMeasurement.height + contentOffset.y >= contentSize.height - paddingToBottom`
  - Use `scrollEventThrottle={400}` to avoid excessive scroll events
  - Component structure: Container ScrollView with content items + loading footer + empty/error states
  - Always reset service state in useEffect cleanup when component unmounts
  - Card styling follows pattern: background from theme.colors.background, borderRadius 8, padding 12
---

## 2025-02-19 23:50 - US-004
- What was implemented:
  - Created `components/memos/relevance-score.tsx` component
  - Implemented `getRelevanceScore(score)` function to convert 0-1 to 0-5 integer scale
  - Display as 5 vertical bars with color coding:
    - 0-2: gray (foregroundTertiary) - low relevance
    - 3: yellow (warning) - medium relevance
    - 4-5: green (success) - high relevance
  - Added tooltip showing "相关度: X/5" with descriptive label on press
  - Exported component from `components/memos/index.ts`
  - Added optional `showLabel` prop to display text description
- Files changed:
  - `components/memos/relevance-score.tsx`: New relevance score component
  - `components/memos/index.ts`: Added export for RelevanceScore
- **Learnings for future iterations:**
  - For hover/tooltip on mobile: use TouchableOpacity with onPressIn/onPressOut
  - Color transparency: use hex + alpha like `"${color}30"` for 30% opacity
  - Tooltip positioning: use absolute positioning with negative margins for centering
  - Component props: make features optional (showLabel) for flexibility in different contexts
  - Score conversion: Math.round(score * 5) handles the 0-1 to 0-5 conversion cleanly
---

## 2025-02-20 00:15 - US-005
- What was implemented:
  - Integrated `RelatedMemoList` component into `app/(memos)/[id].tsx`
  - Added `RelatedMemoService` to bindServices alongside `MemoService`
  - Replaced the old inline related memos section with the new component
  - Added section header with "相关笔记" title and link icon
  - Fixed duplicate React imports (consolidated to single import)
  - Updated RelatedMemoList to use fixed height (300px) for proper rendering inside ScrollView
- Files changed:
  - `app/(memos)/[id].tsx`: Integrated RelatedMemoList, added RelatedMemoService to bindServices
  - `components/memos/related-memo-list.tsx`: Changed container style from flex:1 to fixed height 300px
- **Learnings for future iterations:**
  - When placing a ScrollView-based component inside another ScrollView, use fixed height instead of flex:1
  - The RelatedMemoService auto-resets when memoId changes (handled in loadRelatedMemos method)
  - Components that use services need both the component wrapped with `view()` AND exported with `bindServices()`
  - Always check for duplicate imports when adding new imports to a file
---
