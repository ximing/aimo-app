# PRD: 相关笔记无限滚动列表

## 引言

在备忘录详情页底部添加"相关笔记"区域，展示与当前备忘录相关的其他笔记。支持无限滚动加载，每条笔记展示内容预览、创建时间和相关性分数（以5格形式展示）。

## 目标

- 在备忘录详情页底部展示相关笔记列表
- 实现无限滚动分页加载，直到加载完毕
- 清晰展示每条笔记的相关性分数（0-5分，5格展示）
- 无相关笔记时显示友好提示

## 用户故事

### US-001: 创建相关笔记服务接口
**描述：** 作为开发者，我需要调用后端 API 获取相关笔记数据，支持分页和分数展示。

**验收标准：**
- [ ] 在 `api/memo.ts` 中添加 `getRelatedMemos(memoId, page, pageSize)` 函数
- [ ] 返回类型包含 `id`, `content`, `createTime`, `relevanceScore` 字段
- [ ] 错误处理：API 失败时抛出异常供调用方处理
- [ ] Typecheck/lint 通过

### US-002: 创建相关笔记 Service 层
**描述：** 作为开发者，我需要使用 @rabjs/react Service 管理相关笔记的状态和分页逻辑。

**验收标准：**
- [ ] 创建 `services/related-memo-service.ts`，继承 Service 类
- [ ] 包含 `relatedMemos` 数组、`loading`、`hasMore`、`currentPage` 状态
- [ ] 实现 `loadRelatedMemos(memoId)` 方法，自动处理分页
- [ ] 实现 `reset()` 方法用于切换笔记时重置状态
- [ ] Typecheck/lint 通过

### US-003: 创建相关笔记列表组件
**描述：** 作为用户，我可以在备忘录详情页看到相关笔记列表，支持无限滚动加载。

**验收标准：**
- [ ] 创建 `components/memos/related-memo-list.tsx`
- [ ] 使用 `bindServices` 绑定 `RelatedMemoService`
- [ ] 实现无限滚动：当用户滚动到底部时自动加载下一页
- [ ] 加载时显示 loading 指示器
- [ ] 没有更多数据时显示"已加载全部相关笔记"
- [ ] 笔记卡片样式与现有列表风格一致
- [ ] Typecheck/lint 通过
- [ ] 使用 dev-browser skill 在浏览器中验证

### US-004: 创建相关性分数组件
**描述：** 作为用户，我可以直观地看到每条笔记与当前笔记的相关程度。

**验收标准：**
- [ ] 创建 `components/memos/relevance-score.tsx`
- [ ] 接收 `score` 参数（0-1 之间的原始分数）
- [ ] 使用 `getRelevanceScore` 函数转换为 0-5 分
- [ ] 展示为 5 个格子/圆点，填充数量代表分数（如 3/5 分填充 3 个）
- [ ] 悬停时显示具体分数（如 "相关度: 3/5"）
- [ ] 不同分数段使用不同颜色（如低分灰色、中等黄色、高分绿色）
- [ ] Typecheck/lint 通过
- [ ] 使用 dev-browser skill 在浏览器中验证

### US-005: 集成相关笔记到详情页
**描述：** 作为用户，我可以在查看备忘录详情时直接看到下方的相关笔记。

**验收标准：**
- [ ] 在 `app/(memos)/[id].tsx` 底部添加"相关笔记"区块
- [ ] 使用 `RelatedMemoList` 组件
- [ ] 当 memoId 变化时，重置相关笔记状态
- [ ] 区块标题为"相关笔记"，带图标
- [ ] 无相关笔记时显示"暂无相关笔记"提示
- [ ] Typecheck/lint 通过
- [ ] 使用 dev-browser skill 在浏览器中验证

## 功能需求

- FR-1: 后端 API 返回相关笔记数据，包含 `id`, `content`, `createTime`, `relevanceScore`
- FR-2: 相关性分数原始值为 0-1 之间的小数，使用 `getRelevanceScore(score * 5)` 转换为 0-5 分
- FR-3: 分数展示为 5 个格子/圆点，填充数量代表分数高低
- FR-4: 无限滚动：滚动到底部时自动加载下一页，直到 `hasMore` 为 false
- FR-5: 每条笔记卡片展示内容预览（最多 2-3 行）、创建时间和相关性分数
- FR-6: 无相关笔记时显示"暂无相关笔记"占位提示
- FR-7: 切换备忘录时，相关笔记列表自动重置并重新加载

## 非目标

- 不实现相关性算法计算（后端已提供分数）
- 不提供手动刷新按钮（下拉刷新不属于本次范围）
- 不支持点击相关笔记跳转（保持只读展示）
- 不支持相关笔记的筛选或排序

## 设计考量

- **卡片样式**：复用现有备忘录列表的卡片样式，保持视觉一致性
- **分数展示**：
  ```
  [■■■■■] 5/5 - 高度相关
  [■■■■□] 4/5 - 比较相关
  [■■■□□] 3/5 - 一般相关
  [■■□□□] 2/5 - 弱相关
  [■□□□□] 1/5 - 轻微相关
  [□□□□□] 0/5 - 无相关性
  ```
- **颜色方案**：
  - 4-5 分：绿色系（高度相关）
  - 2-3 分：黄色/橙色系（中等相关）
  - 0-1 分：灰色系（弱相关）
- **无限滚动触发**：距离底部 100px 时触发加载

## 技术考量

- 使用 @rabjs/react Service 管理分页状态和加载逻辑
- 复用现有 API 错误处理模式
- 考虑移动端触摸滚动的性能优化
- 使用 `useCallback` 和 `useMemo` 优化滚动事件处理

## 成功指标

- 相关笔记列表能够无限滚动加载直至全部加载完毕
- 分数展示清晰直观，用户一眼能看出相关程度
- 无相关笔记时提示友好，不显示空白区域
- 切换备忘录时相关笔记正确重置

## 开放问题

- 每页加载数量是多少？（建议 10-20 条）
- 是否需要显示"加载中"骨架屏？
