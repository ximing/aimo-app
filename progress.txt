## Codebase Patterns
- **Service Pattern**: All state management uses @rabjs/react Service class with observable properties
- **bindServices**: Page components using services must be wrapped with bindServices([Service1, Service2])
- **API Layer**: Pure async functions in api/ directory, returning data or throwing errors
- **Component Structure**: Page-specific components go in components/[feature]/ with index.ts for exports
- **Hooks Pattern**: Custom hooks for reusable logic (e.g., useAudioRecorder), following React patterns
- **Type Safety**: All API functions have proper TypeScript types, interfaces in types/ directory
- **Error Handling**: API functions throw errors for callers to handle; Services manage error state
- **Theme Access**: Use useTheme() hook and view decorator from @rabjs/react for theme reactivity

---

## 2026-02-20 - Voice-to-Text Feature Implementation
- What was implemented:
  - Created ASR API (api/asr.ts) with submitTranscriptionTask, getTaskStatus, getTranscriptionResult
  - Created VoiceMemoService (services/voice-memo-service.ts) managing recording + transcription flow
  - Updated useAudioRecorder hook to add formatDuration helper
  - Created VoiceRecorderModal component with recording animation, waveform, duration display
  - Updated floating-action-bar.tsx to integrate VoiceRecorderModal and navigate to create page with audioUri
  - Updated create.tsx to support audioUri query param, auto-upload and transcribe, show status
  - Updated media-preview.tsx to support audio type with mic icon
  - Updated use-media-picker.ts SelectedMedia type to include 'audio'
  - Updated components/memos/index.ts to export VoiceRecorderModal

- Files changed:
  - types/asr.ts (new)
  - api/asr.ts (new)
  - services/voice-memo-service.ts (new)
  - components/memos/voice-recorder-modal.tsx (new)
  - hooks/use-audio-recorder.ts (added formatDuration)
  - hooks/use-media-picker.ts (added 'audio' type)
  - components/memos/floating-action-bar.tsx (integrated VoiceRecorderModal)
  - components/memos/media-preview.tsx (added audio support)
  - components/memos/index.ts (added VoiceRecorderModal export)
  - app/(memos)/create.tsx (integrated VoiceMemoService, audio handling)

- **Learnings for future iterations:**
  - `expo-av` is already installed in the project, use Audio from expo-av for recording
  - Service polling intervals should use `ReturnType<typeof setInterval>` type, not `NodeJS.Timeout` (for React Native compatibility)
  - When navigating with URIs as query params, always use `encodeURIComponent()` to handle special characters
  - The project uses bindServices pattern for page-level components that consume services
  - Media types are defined in SelectedMedia interface in use-media-picker.ts
  - For audio file MIME type, use 'audio/m4a' format
  - The ASR API expects language hints as ['zh', 'en'] and fileUrls as array
  - Toast notifications use showError/showSuccess from @/utils/toast
  - When adding new media types, update both SelectedMedia interface and MediaPreview component
  - Use view decorator from @rabjs/react for components that need theme reactivity
  - Keep API functions pure - no state management, just HTTP calls with error throwing

---

## 2026-02-20 - Voice-to-Text Feature Completion Verification
- What was done:
  - Verified all user stories US-002 through US-008 have been implemented
  - Ran npm run lint - all pass (16 warnings are pre-existing, not related to voice-to-text)
  - Updated prd.json to mark US-002 through US-008 as `passes: true`
  - All acceptance criteria met for each story

- Stories verified:
  - US-002: ASR API interface (api/asr.ts, types/asr.ts)
  - US-003: VoiceRecorderModal component with animation and controls
  - US-004: FloatingActionBar integration with VoiceRecorderModal
  - US-005: MediaPreview audio type support with mic icon
  - US-006: Create page audioUri handling and MediaPreview display
  - US-007: VoiceMemoService with polling and state management
  - US-008: Create page ASR integration with status display and toast notifications

- **No new learnings** - all patterns already documented in previous entry

---

## 2026-02-21 - US-004 - API 层支持筛选和排序参数
- What was implemented:
  - Verified that api/memo.ts getMemos function already supports all required filtering and sorting parameters
  - ListMemosParams type includes: categoryId, sortBy ('createdAt' | 'updatedAt'), sortOrder ('asc' | 'desc')
  - API correctly passes these parameters as query strings
  - Error handling with friendly Chinese error messages is already in place
  - No code changes required - functionality was already implemented

- Files reviewed:
  - api/memo.ts - getMemos function and ListMemosParams handling
  - types/memo.ts - ListMemosParams interface definition
  - services/filter-service.ts - FilterService for filter state management
  - components/memos/filter-drawer.tsx - UI for filter selection

- **Learnings for future iterations:**
  - The API layer already uses `categoryId` parameter for filtering (including `__uncategorized__` for no category)
  - Sort parameters use `sortBy` (not `sortField`) in the API, but FilterService uses `sortField` - this mapping happens in the service layer
  - The API query parameter construction uses URLSearchParams with proper null/undefined checks

---

## 2026-02-21 - US-005 - MemoService 集成筛选和排序功能
- What was implemented:
  - Modified services/memo-service.ts to integrate filter and sort functionality
  - Added filter-related state: categoryFilter, sortField, sortOrder
  - Added FilterService dependency using ioc() from @rabjs/react
  - Created syncFilterState() method to sync state from FilterService
  - Created getFilterParams() method to build API params from filter state
  - Created watchFilterChanges() method to auto-refresh list when filters change
  - Modified fetchMemos() to include filter/sort params in API calls
  - Modified refreshMemos() to sync filter state before fetching
  - Added applyFilterAndRefresh() helper method for explicit filter application

- Files changed:
  - services/memo-service.ts (modified)

- **Learnings for future iterations:**
  - Use `ioc(ServiceClass)` from @rabjs/react to access another service instance
  - Use `$reactive()` method to watch for service state changes
  - Filter params mapping: FilterService.sortField maps to API sortBy param
  - Always sync filter state before refresh to ensure consistency
  - MemoService now automatically reacts to FilterService changes when watchFilterChanges() is called

---

## 2026-02-21 - US-006 - 搜索入口改造 - 点击跳转搜索页面
- What was implemented:
  - Modified components/memos/search-header.tsx
  - Wrapped search container with TouchableOpacity for navigation
  - Made TextInput read-only with `editable={false}` and `pointerEvents="none"`
  - Added router.push('/search') navigation using expo-router's useRouter
  - Changed placeholder text from "搜索笔记" to "搜索笔记..."
  - Removed local search state (searchQuery, setSearchQuery) and search handlers
  - Cleaned up unused imports (useState, Text from react-native)

- Files changed:
  - components/memos/search-header.tsx (modified)

- **Learnings for future iterations:**
  - To make a search box read-only and clickable, wrap it with TouchableOpacity and set TextInput's `editable={false}` and `pointerEvents="none"`
  - Use `useRouter` from expo-router for navigation in React Native components
  - The project pattern for navigation is `router.push('/route-path')`
  - When removing state management from a component, remember to clean up unused imports

---

## 2026-02-21 - US-007 - 创建 SearchService 管理搜索状态和最近搜索历史
- What was implemented:
  - Created services/search-service.ts extending @rabjs/react Service class
  - State management: searchKeyword, searchResults, isSearching, recentSearches, searchFilters
  - SearchFilters interface with categoryId and dateRange (start/end Date)
  - AsyncStorage persistence for recentSearches (key: 'recentSearches'), max 10 items
  - Methods implemented:
    - loadRecentSearches() - load from AsyncStorage on init
    - addRecentSearch(keyword) - insert at top, deduplicate, limit to 10
    - removeRecentSearch(keyword) - remove single entry
    - clearRecentSearches() - clear all history
    - search(keyword, filters) - execute search (API integration placeholder for US-012)
    - setSearchKeyword(), setSearchFilters(), clearSearchFilters()
    - loadNextPage() - pagination support
    - clearSearchResults(), reset() - cleanup methods

- Files changed:
  - services/search-service.ts (new)

- **Learnings for future iterations:**
  - SearchService follows same pattern as FilterService for AsyncStorage persistence
  - Use splice() to modify observable arrays in @rabjs/react (direct assignment works but splice is cleaner for array modifications)
  - Date range filters use Date objects internally, will convert to ISO strings for API calls
  - The search() method has TODO placeholder for API integration (US-012)
  - Recent searches are stored as simple string array, not complex objects (simpler UX)
  - SearchService manages its own pagination state (currentPage, pageSize, hasMore)

---

## 2026-02-21 - US-008 - 创建搜索页面 SearchPage 基础结构
- What was implemented:
  - Created app/search.tsx with full search page structure
  - Top header with back button (router.back()) and search input
  - Search input with autoFocus using ref and setTimeout
  - Clear button appears when input has text, clears input and refocuses
  - Recent searches section with history icon and keyword
  - Delete (X) button on each recent search to remove single entry
  - Clear All button to clear all recent searches
  - Filter bar with Date and Category buttons (UI only, functionality in US-010)
  - Empty state with search icon and "输入关键词开始搜索" message
  - Integrated SearchService and CategoryService via bindServices

- Files changed:
  - app/search.tsx (new)

- **Learnings for future iterations:**
  - Use `useRef<TextInput>(null)` + `inputRef.current?.focus()` for auto-focus
  - Delay auto-focus with setTimeout to ensure page is fully loaded
  - For search input with clear button, use conditional rendering based on text length
  - Recent search items: Use history icon + text with delete button on right
  - Use `hitSlop` prop on TouchableOpacity to increase touch target without affecting visual size
  - Filter bar buttons use row layout with icon + text + dropdown arrow
  - Empty state pattern: Large icon (64px) + descriptive text, centered with paddingTop

---
